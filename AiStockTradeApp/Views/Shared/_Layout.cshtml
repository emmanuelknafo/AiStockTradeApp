@using Microsoft.AspNetCore.Localization
@using Microsoft.AspNetCore.Http
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer
<!DOCTYPE html>
<html lang="@System.Threading.Thread.CurrentThread.CurrentUICulture.TwoLetterISOLanguageName">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - @Localizer["App_Title"]</title>
    <link rel="stylesheet" href="~/css/stock-tracker.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
</head>
<body>
    <main role="main">
        <div style="padding:8px 16px; border-bottom:1px solid #eee; margin-bottom:12px; display:flex; gap:12px; align-items:center;">
            @if (User.Identity?.IsAuthenticated == true)
            {
                <a href="@Url.Action("Dashboard","UserStock")" style="margin-right:12px;">@Localizer["Nav_Dashboard"]</a>
                <a href="@Url.Action("ManageWatchlist","UserStock")">@Localizer["Nav_ManageWatchlist"]</a>
            }
            else
            {
                <a href="@Url.Action("Dashboard","Stock")" style="margin-right:12px;">@Localizer["Nav_Dashboard"]</a>
            }
            <a href="@Url.Action("Index","ListedStocks")">@Localizer["Nav_ListedStocks"]</a>
            <div style="margin-left:auto; display:flex; gap:12px; align-items:center;">
                @if (User.Identity?.IsAuthenticated == true)
                {
                    <div style="display:flex; gap:8px; align-items:center;">
                        <span style="color:#666;">@Localizer["Nav_Welcome"], @User.Identity.Name</span>
                        <a href="@Url.Action("Profile","Account")" style="text-decoration:none;">
                            <i class="fas fa-user"></i> @Localizer["Nav_Profile"]
                        </a>
                        <form method="post" action="@Url.Action("Logout","Account")" style="display:inline;">
                            @Html.AntiForgeryToken()
                            <button type="submit" style="background:none; border:none; color:#007bff; text-decoration:underline; cursor:pointer;">
                                <i class="fas fa-sign-out-alt"></i> @Localizer["Nav_Logout"]
                            </button>
                        </form>
                    </div>
                }
                else
                {
                    <div style="display:flex; gap:8px;">
                        <a href="@Url.Action("Login","Account")" style="text-decoration:none;">
                            <i class="fas fa-sign-in-alt"></i> @Localizer["Nav_Login"]
                        </a>
                        <a href="@Url.Action("Register","Account")" style="text-decoration:none;">
                            <i class="fas fa-user-plus"></i> @Localizer["Nav_Register"]
                        </a>
                    </div>
                }
                <form id="culture-form" method="post" action="@Url.Action("SetLanguage","Home")" class="form-inline">
                    @Html.AntiForgeryToken()
                    <select name="culture" onchange="document.getElementById('culture-form').submit();">
                        @{ var currentLang = System.Globalization.CultureInfo.CurrentUICulture.TwoLetterISOLanguageName; }
                        <option value="en" selected="@(currentLang == "en" ? "selected" : null)">@Localizer["Lang_English"]</option>
                        <option value="fr" selected="@(currentLang == "fr" ? "selected" : null)">@Localizer["Lang_French"]</option>
                    </select>
                    <input type="hidden" name="returnUrl" value="@(Context.Request.Path + Context.Request.QueryString)" />
                </form>
            </div>
        </div>
        @RenderBody()
    </main>

    <footer style="margin-top:2rem;text-align:center;font-size:0.8rem;color:#777;">
        @await Html.PartialAsync("_FooterVersion")
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@3.2.12/dist/jquery.validate.unobtrusive.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Global error handler to filter extension errors -->
    <script>
        // Filter out common extension-related errors that don't affect the application
        window.addEventListener('error', function(e) {
            // Check if it's an extension-related error
            if (e.message && e.message.includes('Extension')) {
                console.log('Filtered extension error:', e.message);
                return true; // Prevent default error handling
            }
        });
        
        // Console error filtering for runtime.lastError
        const originalError = console.error;
        console.error = function(...args) {
            const message = args.join(' ');
            if (message.includes('runtime.lastError') || 
                message.includes('message channel closed') ||
                message.includes('Extension')) {
                // Log as info instead of error for extension-related issues
                console.info('Extension message (filtered):', ...args);
                return;
            }
            originalError.apply(console, args);
        };
    </script>
    
    <script src="~/js/stock-tracker.js" asp-append-version="true"></script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>
