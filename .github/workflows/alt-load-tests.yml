name: Alt Load Tests - dev-002

on:
  push:
    branches: ['*']
    paths:
      - 'load-tests/**'
      - '.github/workflows/alt-load-tests.yml'
  pull_request:
    branches: ['*']
    paths:
      - 'load-tests/**'
      - '.github/workflows/alt-load-tests.yml'

env:
  LOAD_TEST_RESOURCE: lt-aistock-dev-002
  LOAD_TEST_RESOURCE_GROUP: rg-aistock-dev-002
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}

jobs:
  load_test:
    name: Run Azure Load Test (dev-002)
    runs-on: [self-hosted, linux, x64]
    permissions:
      id-token: write
      contents: write # needed to push git tag

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Prepare load test files
        run: |
          echo "Preparing load test files"
          mkdir -p .github/workflows/load-tests || true
          cp -v load-tests/paths.csv .github/workflows/load-tests/paths.csv || true
          cp -v load-tests/jmeter/test-plan.azure.jmx .github/workflows/test-plan.azure.jmx || true
          cp -v load-tests/jmeter/test-plan.jmx .github/workflows/test-plan.jmx || true
          cp -v load-tests/jmeter/test-plan.generated.jmx .github/workflows/test-plan.generated.jmx || true

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Start Azure Load Test run (dev-002)
        env:
          AZ_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
          LOAD_TEST_RESOURCE: ${{ env.LOAD_TEST_RESOURCE }}
          LOAD_TEST_RESOURCE_GROUP: ${{ env.LOAD_TEST_RESOURCE_GROUP }}
        run: |
          set -eo pipefail
          echo "Triggering Azure Load Test run for resource: $LOAD_TEST_RESOURCE in group: $LOAD_TEST_RESOURCE_GROUP"

          echo "Installing PyYAML to parse YAML"
          python -m pip install --quiet pyyaml

          CONFIG_PATH=".azuredevops/pipelines/alt-config.yml"
          if [ ! -f "$CONFIG_PATH" ]; then
            echo "Configuration file $CONFIG_PATH not found" >&2
            exit 1
          fi

          # Build run-body.json by loading alt-config.yml and replacing dev-003 -> dev-002
          python -c 'import yaml,json,re,sys; s=open(".azuredevops/pipelines/alt-config.yml","r",encoding="utf-8").read(); s=re.sub(r"aistock-dev-003","aistock-dev-002",s); s=re.sub(r"dev-003","dev-002",s); cfg=yaml.safe_load(s); import json as _json; print(_json.dumps({"properties":cfg}, indent=2))' > run-body.json

          API_VERSION="2022-12-01-preview"
          URI="https://management.azure.com/subscriptions/${AZ_SUBSCRIPTION_ID}/resourceGroups/${LOAD_TEST_RESOURCE_GROUP}/providers/Microsoft.LoadTestService/loadTests/${LOAD_TEST_RESOURCE}/run?api-version=${API_VERSION}"

          echo "Calling Azure REST API to start the run (response shown)"
          az rest --method post --uri "$URI" --body @run-body.json --output json

      - name: Upload run artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: load-test-artifacts-dev-002
          path: |
            .github/workflows/load-tests/**
            .github/workflows/test-plan.*
            run-body.json
