name: Infrastructure Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy infrastructure'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - prod
      location:
        description: 'Azure region for deployment'
        required: true
        default: 'Canada Central'
        type: string
      destroy:
        description: 'Destroy infrastructure instead of deploy'
        required: false
        default: false
        type: boolean

env:
  AZURE_RESOURCE_GROUP_DEV: 'rg-ai-stock-tracker-dev'
  AZURE_RESOURCE_GROUP_PROD: 'rg-ai-stock-tracker-prod'

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    name: Deploy Infrastructure
    environment: ${{ github.event.inputs.environment == 'prod' && 'production' || 'development' }}
    
    permissions:
      id-token: write
      contents: read
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Azure Login
      uses: azure/login@v2
      with:
        client-id: ${{ vars.AZURE_CLIENT_ID }}
        tenant-id: ${{ vars.AZURE_TENANT_ID }}
        subscription-id: ${{ vars.AZURE_SUBSCRIPTION_ID }}

    - name: Create Resource Group
      if: github.event.inputs.destroy != 'true'
      run: |
        if [ "${{ github.event.inputs.environment }}" == "prod" ]; then
          RG_NAME="${{ env.AZURE_RESOURCE_GROUP_PROD }}"
        else
          RG_NAME="${{ env.AZURE_RESOURCE_GROUP_DEV }}"
        fi
        
        az group create --name "$RG_NAME" --location "${{ github.event.inputs.location }}"

    - name: Validate Bicep Template
      if: github.event.inputs.destroy != 'true'
      run: |
        az deployment group validate \
          --resource-group ${{ github.event.inputs.environment == 'prod' && env.AZURE_RESOURCE_GROUP_PROD || env.AZURE_RESOURCE_GROUP_DEV }} \
          --template-file ./infrastructure/main.bicep \
          --parameters ./infrastructure/parameters.${{ github.event.inputs.environment }}.json \
          --parameters location="${{ github.event.inputs.location }}" \
          --parameters containerImage="ai-stock-trade-app:latest" \
          --parameters alphaVantageApiKey="${{ secrets.ALPHA_VANTAGE_API_KEY }}" \
          --parameters twelveDataApiKey="${{ secrets.TWELVE_DATA_API_KEY }}"

    - name: Deploy Bicep Template
      if: github.event.inputs.destroy != 'true'
      run: |
        az deployment group create \
          --resource-group ${{ github.event.inputs.environment == 'prod' && env.AZURE_RESOURCE_GROUP_PROD || env.AZURE_RESOURCE_GROUP_DEV }} \
          --template-file ./infrastructure/main.bicep \
          --parameters ./infrastructure/parameters.${{ github.event.inputs.environment }}.json \
          --parameters location="${{ github.event.inputs.location }}" \
          --parameters containerImage="ai-stock-trade-app:latest" \
          --parameters alphaVantageApiKey="${{ secrets.ALPHA_VANTAGE_API_KEY }}" \
          --parameters twelveDataApiKey="${{ secrets.TWELVE_DATA_API_KEY }}"

    - name: Destroy Infrastructure
      if: github.event.inputs.destroy == 'true'
      run: |
        if [ "${{ github.event.inputs.environment }}" == "prod" ]; then
          RG_NAME="${{ env.AZURE_RESOURCE_GROUP_PROD }}"
        else
          RG_NAME="${{ env.AZURE_RESOURCE_GROUP_DEV }}"
        fi
        
        echo "Destroying resource group: $RG_NAME"
        az group delete --name "$RG_NAME" --yes --no-wait

    - name: Deployment Summary
      if: github.event.inputs.destroy != 'true'
      run: |
        echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group**: ${{ github.event.inputs.environment == 'prod' && env.AZURE_RESOURCE_GROUP_PROD || env.AZURE_RESOURCE_GROUP_DEV }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Status**: Infrastructure deployment completed" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ github.event.inputs.environment }}" == "prod" ]; then
          echo "- **Web App URL**: https://ai-stock-tracker-prod-webapp.azurewebsites.net" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Web App URL**: https://ai-stock-tracker-dev-webapp.azurewebsites.net" >> $GITHUB_STEP_SUMMARY

        fi
